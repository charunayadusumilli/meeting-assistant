{"version":3,"file":"net-breadcrumbs.js","sources":["../../../src/main/integrations/net-breadcrumbs.ts"],"sourcesContent":["import {\n  addBreadcrumb,\n  debug,\n  defineIntegration,\n  fill,\n  getBreadcrumbLogLevelFromHttpStatusCode,\n  getTraceData,\n  LRUMap,\n  SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN,\n  SentryNonRecordingSpan,\n  setHttpStatus,\n  startInactiveSpan,\n  stringMatchesSomePattern,\n  TracePropagationTargets,\n} from '@sentry/core';\nimport { logger } from '@sentry/node';\nimport { ClientRequest, ClientRequestConstructorOptions, IncomingMessage, net as electronNet } from 'electron';\nimport * as urlModule from 'url';\n\ntype ShouldTraceFn = (method: string, url: string) => boolean;\n\nexport interface NetOptions {\n  /**\n   * Whether breadcrumbs should be captured for net requests\n   *\n   * Defaults to: true\n   */\n  breadcrumbs?: boolean;\n  /**\n   * Whether to capture transaction spans for net requests\n   *\n   * true | false | (method: string, url: string) => boolean\n   * Defaults to: true\n   */\n  tracing?: ShouldTraceFn | boolean;\n}\n\n/**\n * Trimmed down version of the code from Electron here:\n * https://github.com/electron/electron/blob/f3df76dbdc58cb704637b89357e1400791c92cfe/lib/browser/api/net.ts#L209-L269\n *\n * We want to match the final URL that Electron uses\n */\nfunction parseOptions(optionsIn: ClientRequestConstructorOptions | string): { method: string; url: string } {\n  const { method, options } =\n    typeof optionsIn === 'string'\n      ? // eslint-disable-next-line deprecation/deprecation\n        { method: 'GET', options: urlModule.parse(optionsIn) }\n      : { method: (optionsIn.method || 'GET').toUpperCase(), options: optionsIn };\n\n  let url = 'url' in options ? options.url : undefined;\n\n  if (!url) {\n    const urlObj: urlModule.UrlObject = {};\n    urlObj.protocol = options.protocol || 'http:';\n\n    if (options.host) {\n      urlObj.host = options.host;\n    } else {\n      if (options.hostname) {\n        urlObj.hostname = options.hostname;\n      } else {\n        urlObj.hostname = 'localhost';\n      }\n\n      if (options.port) {\n        urlObj.port = options.port;\n      }\n    }\n\n    // eslint-disable-next-line deprecation/deprecation\n    const pathObj = urlModule.parse(options.path || '/');\n    urlObj.pathname = pathObj.pathname;\n    urlObj.search = pathObj.search;\n    urlObj.hash = pathObj.hash;\n    url = urlModule.format(urlObj);\n  }\n\n  return {\n    method,\n    url,\n  };\n}\n\ntype RequestOptions = string | ClientRequestConstructorOptions;\ntype RequestMethod = (opt: RequestOptions) => ClientRequest;\ntype WrappedRequestMethodFactory = (original: RequestMethod) => RequestMethod;\n\nfunction createWrappedRequestFactory(\n  options: NetOptions,\n  enableLogs: boolean,\n  tracePropagationTargets: TracePropagationTargets | undefined,\n): WrappedRequestMethodFactory {\n  // We're caching results so we don't have to recompute regexp every time we create a request.\n  const createSpanUrlMap = new LRUMap<string, boolean>(100);\n  const headersUrlMap = new LRUMap<string, boolean>(100);\n\n  const shouldCreateSpan = (method: string, url: string): boolean => {\n    if (options.tracing === undefined) {\n      return true;\n    }\n\n    if (options.tracing === false) {\n      return false;\n    }\n\n    const key = `${method}:${url}`;\n\n    const cachedDecision = createSpanUrlMap.get(key);\n    if (cachedDecision !== undefined) {\n      return cachedDecision;\n    }\n\n    const decision = options.tracing === true || options.tracing(method, url);\n    createSpanUrlMap.set(key, decision);\n    return decision;\n  };\n\n  // This will be considerably simpler once `tracingOrigins` is removed in the next major release\n  const shouldAttachTraceData = (method: string, url: string): boolean => {\n    const key = `${method}:${url}`;\n\n    const cachedDecision = headersUrlMap.get(key);\n    if (cachedDecision !== undefined) {\n      return cachedDecision;\n    }\n\n    if (tracePropagationTargets) {\n      const decision = stringMatchesSomePattern(url, tracePropagationTargets);\n      headersUrlMap.set(key, decision);\n      return decision;\n    }\n\n    // We cannot reach here since either `tracePropagationTargets` or `tracingOrigins` will be defined but TypeScript\n    // cannot infer that\n    return true;\n  };\n\n  /**\n   * Captures Breadcrumb based on provided request/response pair\n   */\n  const addRequestBreadcrumb = (\n    event: string,\n    method: string,\n    url: string,\n    req: ClientRequest,\n    res?: IncomingMessage,\n  ): void => {\n    const level = getBreadcrumbLogLevelFromHttpStatusCode(res?.statusCode);\n\n    addBreadcrumb(\n      {\n        type: 'http',\n        category: 'electron.net',\n        data: {\n          url,\n          method: method,\n          status_code: res?.statusCode,\n        },\n        level,\n      },\n      {\n        event,\n        request: req,\n        response: res,\n      },\n    );\n\n    if (!enableLogs) {\n      return;\n    }\n\n    const attributes = {\n      'sentry.origin': 'auto.electron.net',\n      statusCode: res?.statusCode,\n    };\n\n    switch (level) {\n      case 'error':\n        logger.error(logger.fmt`Electron.net request failed: ${method} ${url}`, attributes);\n        break;\n      case 'warning':\n        logger.warn(logger.fmt`Electron.net request warning: ${method} ${url}`, attributes);\n        break;\n      default:\n        logger.info(logger.fmt`Electron.net request succeeded: ${method} ${url}`, attributes);\n    }\n  };\n\n  return function wrappedRequestMethodFactory(originalRequestMethod: RequestMethod): RequestMethod {\n    return function requestMethod(this: typeof electronNet, reqOptions: RequestOptions): ClientRequest {\n      const { url, method } = parseOptions(reqOptions);\n      const request = originalRequestMethod.apply(this, [reqOptions]) as ClientRequest;\n\n      if (url.match(/sentry_key/) || request.getHeader('x-sentry-auth')) {\n        return request;\n      }\n\n      const span = shouldCreateSpan(method, url)\n        ? startInactiveSpan({\n            name: `${method} ${url}`,\n            onlyIfParent: true,\n            attributes: {\n              url,\n              type: 'net.request',\n              'http.method': method,\n            },\n            op: 'http.client',\n          })\n        : new SentryNonRecordingSpan();\n\n      span.setAttribute(SEMANTIC_ATTRIBUTE_SENTRY_ORIGIN, 'auto.http.electron.net');\n\n      if (shouldAttachTraceData(method, url)) {\n        for (const [key, value] of Object.entries(getTraceData({ span }))) {\n          debug.log(`[Tracing] Adding ${key} header ${value} to outgoing request to \"${url}\": `);\n          request.setHeader(key, value);\n        }\n      }\n\n      return request\n        .once('response', function (this: ClientRequest, res: IncomingMessage): void {\n          if (options.breadcrumbs !== false) {\n            addRequestBreadcrumb('response', method, url, this, res);\n          }\n\n          if (res.statusCode) {\n            setHttpStatus(span, res.statusCode);\n          }\n\n          span.end();\n        })\n        .once('error', function (this: ClientRequest, _error: Error): void {\n          if (options.breadcrumbs !== false) {\n            addRequestBreadcrumb('error', method, url, this, undefined);\n          }\n\n          setHttpStatus(span, 500);\n          span.end();\n        });\n    };\n  };\n}\n\n/**\n * Electron 'net' module integration\n */\nexport const electronNetIntegration = defineIntegration((options: NetOptions = {}) => {\n  return {\n    name: 'ElectronNet',\n    setup(client) {\n      const clientOptions = client.getOptions();\n      const enableLogs = !!clientOptions?.enableLogs;\n\n      // No need to instrument if we don't want to track anything\n      if (options.breadcrumbs === false && options.tracing === false) {\n        return;\n      }\n\n      fill(\n        electronNet,\n        'request',\n        createWrappedRequestFactory(options, enableLogs, clientOptions?.tracePropagationTargets),\n      );\n    },\n  };\n});\n"],"names":["electronNet"],"mappings":"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"}