{"version":3,"file":"renderer-anr.js","sources":["../../../src/main/integrations/renderer-anr.ts"],"sourcesContent":["import {\n  callFrameToStackFrame,\n  captureEvent,\n  Client,\n  debug,\n  defineIntegration,\n  Event,\n  Integration,\n  StackFrame,\n  stripSentryFramesAndReverse,\n  watchdogTimer,\n} from '@sentry/core';\nimport { createGetModuleFromFilename } from '@sentry/node';\nimport { app, powerMonitor, WebContents } from 'electron';\nimport { RendererStatus } from '../../common/ipc.js';\nimport { ELECTRON_MAJOR_VERSION } from '../electron-normalize.js';\nimport { addHeaderToSession } from '../header-injection.js';\nimport { ElectronMainOptionsInternal } from '../sdk.js';\nimport { sessionAnr } from '../sessions.js';\nimport { captureRendererStackFrames } from '../stack-parse.js';\n\nfunction log(message: string, ...args: unknown[]): void {\n  debug.log(`[Renderer Event Loop Block] ${message}`, ...args);\n}\n\ninterface ScriptParsedEventDataType {\n  scriptId: string;\n  url: string;\n}\n\ninterface Location {\n  scriptId: string;\n  lineNumber: number;\n  columnNumber?: number;\n}\n\ninterface CallFrame {\n  functionName: string;\n  location: Location;\n  url: string;\n}\n\ninterface PausedEventDataType {\n  callFrames: CallFrame[];\n  reason: string;\n}\n\ntype StackFramesCallback = (frames: StackFrame[]) => void;\n\n/**\n * Captures stack frames via the native frame.collectJavaScriptCallStack() API\n */\nfunction nativeStackTraceCapture(contents: WebContents, pausedStack: StackFramesCallback): () => void {\n  return () => {\n    captureRendererStackFrames(contents)\n      .then((frames) => {\n        if (frames) {\n          pausedStack(frames);\n        }\n      })\n      .catch(() => {\n        // ignore\n      });\n  };\n}\n\n/**\n * Captures stack frames via the debugger\n */\nfunction debuggerStackTraceCapture(contents: WebContents, pausedStack: StackFramesCallback): () => void {\n  log('Connecting to debugger');\n  contents.debugger.attach('1.3');\n\n  // Collect scriptId -> url map so we can look up the filenames later\n  const scripts = new Map<string, string>();\n  const getModuleFromFilename = createGetModuleFromFilename(app.getAppPath());\n\n  contents.debugger.on('message', (_, method, params) => {\n    if (method === 'Debugger.scriptParsed') {\n      const param = params as ScriptParsedEventDataType;\n      scripts.set(param.scriptId, param.url);\n    } else if (method === 'Debugger.paused') {\n      const param = params as PausedEventDataType;\n\n      if (param.reason !== 'other') {\n        return;\n      }\n\n      // copy the frames\n      const callFrames = [...param.callFrames];\n\n      contents.debugger.sendCommand('Debugger.resume').then(null, () => {\n        // ignore\n      });\n\n      const stackFrames = stripSentryFramesAndReverse(\n        callFrames.map((frame) =>\n          callFrameToStackFrame(frame, scripts.get(frame.location.scriptId), getModuleFromFilename),\n        ),\n      );\n\n      pausedStack(stackFrames);\n    }\n  });\n\n  // In node, we enable just before pausing but for Chrome, the debugger must be enabled before he ANR event occurs\n  contents.debugger.sendCommand('Debugger.enable').catch(() => {\n    // ignore\n  });\n\n  return () => {\n    if (contents.isDestroyed()) {\n      return;\n    }\n\n    log('Pausing debugger to capture stack trace');\n    return contents.debugger.sendCommand('Debugger.pause');\n  };\n}\n\nfunction createHrTimer(): { getTimeMs: () => number; reset: () => void } {\n  let lastPoll = process.hrtime();\n\n  return {\n    getTimeMs: (): number => {\n      const [seconds, nanoSeconds] = process.hrtime(lastPoll);\n      return Math.floor(seconds * 1e3 + nanoSeconds / 1e6);\n    },\n    reset: (): void => {\n      lastPoll = process.hrtime();\n    },\n  };\n}\n\nconst INTEGRATION_NAME = 'RendererEventLoopBlock';\n\ntype Options = {\n  /**\n   * Enables injection of 'include-js-call-stacks-in-crash-reports' document policy headers so that renderer call stacks\n   * can be captured from the main process without using the debugger API.\n   *\n   * Requires Electron >= v34\n   *\n   * @default false\n   */\n  captureNativeStacktrace?: boolean;\n};\n\ntype RendererStatusHandler = (status: RendererStatus, contents: WebContents) => void;\n\ntype RendererEventLoopBlockIntegration = Integration & {\n  createRendererEventLoopBlockStatusHandler: () => RendererStatusHandler;\n};\n\n/**\n * An integration that captures App Not Responding events from renderer processes\n */\nexport const rendererEventLoopBlockIntegration: (options?: Options) => RendererEventLoopBlockIntegration =\n  defineIntegration((options: Options = {}) => {\n    const rendererWatchdogTimers = new Map<WebContents, ReturnType<typeof watchdogTimer>>();\n    let clientOptions: ElectronMainOptionsInternal | undefined;\n\n    function getRendererName(contents: WebContents): string | undefined {\n      return clientOptions?.getRendererName?.(contents);\n    }\n\n    function sendRendererEventLoopBlockEvent(contents: WebContents, blockedMs: number, frames?: StackFrame[]): void {\n      sessionAnr();\n\n      const rendererName = getRendererName(contents) || 'renderer';\n\n      const event: Event = {\n        level: 'error',\n        exception: {\n          values: [\n            {\n              type: 'ApplicationNotResponding',\n              value: `Application Not Responding for at least ${blockedMs} ms`,\n              stacktrace: { frames },\n              mechanism: {\n                // This ensures the UI doesn't say 'Crashed in' for the stack trace\n                type: 'ANR',\n              },\n            },\n          ],\n        },\n        tags: {\n          'event.process': rendererName,\n        },\n      };\n\n      captureEvent(event);\n    }\n\n    return {\n      name: INTEGRATION_NAME,\n      setup: (client) => {\n        clientOptions = client.getOptions() as ElectronMainOptionsInternal;\n\n        if (ELECTRON_MAJOR_VERSION >= 34) {\n          app.commandLine.appendSwitch('enable-features', 'DocumentPolicyIncludeJSCallStacksInCrashReports');\n\n          if (options.captureNativeStacktrace) {\n            app.on('ready', () => {\n              clientOptions\n                ?.getSessions()\n                .forEach((sesh) =>\n                  addHeaderToSession(sesh, 'Document-Policy', 'include-js-call-stacks-in-crash-reports'),\n                );\n            });\n          }\n        }\n      },\n      createRendererEventLoopBlockStatusHandler: (): RendererStatusHandler => {\n        return (message: RendererStatus, contents: WebContents): void => {\n          let watchdog = rendererWatchdogTimers.get(contents);\n\n          // eslint-disable-next-line jsdoc/require-jsdoc\n          function disable(): void {\n            watchdog?.enabled(false);\n          }\n\n          // eslint-disable-next-line jsdoc/require-jsdoc\n          function enable(): void {\n            watchdog?.enabled(true);\n          }\n\n          if (watchdog === undefined) {\n            log('Renderer sent first status message', message.config);\n            let pauseAndCapture: (() => void) | undefined;\n\n            if (message.config.captureStackTrace) {\n              const stackCaptureImpl =\n                options.captureNativeStacktrace && ELECTRON_MAJOR_VERSION >= 34\n                  ? nativeStackTraceCapture\n                  : debuggerStackTraceCapture;\n\n              pauseAndCapture = stackCaptureImpl(contents, (frames) => {\n                log('Event captured with stack frames');\n                sendRendererEventLoopBlockEvent(contents, message.config.anrThreshold, frames);\n              });\n            }\n\n            watchdog = watchdogTimer(createHrTimer, 100, message.config.anrThreshold, async () => {\n              log('Watchdog timeout');\n              if (pauseAndCapture) {\n                pauseAndCapture();\n              } else {\n                log('Capturing event');\n                sendRendererEventLoopBlockEvent(contents, message.config.anrThreshold);\n              }\n            });\n\n            contents.once('destroyed', () => {\n              rendererWatchdogTimers?.delete(contents);\n\n              powerMonitor.off('suspend', disable);\n              powerMonitor.off('resume', enable);\n              powerMonitor.off('lock-screen', disable);\n              powerMonitor.off('unlock-screen', enable);\n            });\n\n            contents.once('blur', disable);\n            contents.once('focus', enable);\n            powerMonitor.on('suspend', disable);\n            powerMonitor.on('resume', enable);\n            powerMonitor.on('lock-screen', disable);\n            powerMonitor.on('unlock-screen', enable);\n\n            rendererWatchdogTimers.set(contents, watchdog);\n          }\n\n          watchdog.poll();\n\n          if (message.status !== 'alive') {\n            log(`Renderer visibility changed '${message.status}'`);\n            watchdog.enabled(message.status === 'visible');\n          }\n        };\n      },\n    };\n  }) as (options?: Options) => RendererEventLoopBlockIntegration;\n\n/**\n * Creates a hook which notifies the integration when the state of renderers change\n */\nexport function createRendererEventLoopBlockStatusHandler(client: Client): RendererStatusHandler | undefined {\n  const integration = client.getIntegrationByName(INTEGRATION_NAME) as unknown as\n    | RendererEventLoopBlockIntegration\n    | undefined;\n  return integration?.createRendererEventLoopBlockStatusHandler();\n}\n"],"names":[],"mappings":"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"}