{"version":3,"file":"ipc.js","sources":["../../src/main/ipc.ts"],"sourcesContent":["import {\n  _INTERNAL_captureSerializedLog,\n  Attachment,\n  Client,\n  debug,\n  DynamicSamplingContext,\n  Event,\n  parseEnvelope,\n  ScopeData,\n  SerializedLog,\n} from '@sentry/core';\nimport { captureEvent, getClient, getCurrentScope } from '@sentry/node';\nimport { app, ipcMain, protocol, WebContents, webContents } from 'electron';\nimport { eventFromEnvelope } from '../common/envelope.js';\nimport { ipcChannelUtils, IPCMode, IpcUtils, RendererStatus } from '../common/ipc.js';\nimport { registerProtocol } from './electron-normalize.js';\nimport { createRendererEventLoopBlockStatusHandler } from './integrations/renderer-anr.js';\nimport { rendererProfileFromIpc } from './integrations/renderer-profiling.js';\nimport { getOsDeviceLogAttributes } from './log.js';\nimport { mergeEvents } from './merge.js';\nimport { normalizeReplayEnvelope } from './normalize.js';\nimport { ElectronMainOptionsInternal } from './sdk.js';\nimport { SDK_VERSION } from './version.js';\n\nlet KNOWN_RENDERERS: Set<number> | undefined;\nlet WINDOW_ID_TO_WEB_CONTENTS: Map<string, number> | undefined;\n\nfunction newProtocolRenderer(): void {\n  KNOWN_RENDERERS = KNOWN_RENDERERS || new Set();\n  WINDOW_ID_TO_WEB_CONTENTS = WINDOW_ID_TO_WEB_CONTENTS || new Map();\n\n  for (const wc of webContents.getAllWebContents()) {\n    const wcId = wc.id;\n    if (KNOWN_RENDERERS.has(wcId)) {\n      continue;\n    }\n\n    if (!wc.isDestroyed()) {\n      wc.executeJavaScript('window.__SENTRY_RENDERER_ID__').then((windowId: string | undefined) => {\n        if (windowId && KNOWN_RENDERERS && WINDOW_ID_TO_WEB_CONTENTS) {\n          KNOWN_RENDERERS.add(wcId);\n          WINDOW_ID_TO_WEB_CONTENTS.set(windowId, wcId);\n\n          wc.once('destroyed', () => {\n            KNOWN_RENDERERS?.delete(wcId);\n            WINDOW_ID_TO_WEB_CONTENTS?.delete(windowId);\n          });\n        }\n      }, debug.error);\n    }\n  }\n}\n\nfunction captureEventFromRenderer(\n  options: ElectronMainOptionsInternal,\n  event: Event,\n  dynamicSamplingContext: Partial<DynamicSamplingContext> | undefined,\n  attachments: Attachment[],\n  contents: WebContents | undefined,\n): void {\n  const process = contents ? options?.getRendererName?.(contents) || 'renderer' : 'renderer';\n\n  // Ensure breadcrumbs are empty as they sent via scope updates\n  event.breadcrumbs = event.breadcrumbs || [];\n\n  // Remove the environment as it defaults to 'production' and overwrites the main process environment\n  delete event.environment;\n\n  // Remove the SDK info as we want the Electron SDK to be the one reporting the event\n  delete event.sdk?.name;\n  delete event.sdk?.version;\n  delete event.sdk?.packages;\n\n  if (dynamicSamplingContext) {\n    event.sdkProcessingMetadata = { ...event.sdkProcessingMetadata, dynamicSamplingContext };\n  }\n\n  captureEvent(mergeEvents(event, { tags: { 'event.process': process } }), { attachments });\n}\n\nlet cached_public_key: string | undefined;\n\nfunction handleEnvelope(\n  client: Client,\n  options: ElectronMainOptionsInternal,\n  env: Uint8Array | string,\n  contents?: WebContents,\n): void {\n  const envelope = parseEnvelope(env);\n\n  const [envelopeHeader] = envelope;\n  const dynamicSamplingContext = envelopeHeader.trace as DynamicSamplingContext | undefined;\n\n  if (dynamicSamplingContext) {\n    if (!cached_public_key) {\n      const dsn = client.getDsn();\n      cached_public_key = dsn?.publicKey;\n    }\n\n    dynamicSamplingContext.release = options.release;\n    dynamicSamplingContext.environment = options.environment;\n    dynamicSamplingContext.public_key = cached_public_key;\n  }\n\n  const eventAndAttachments = eventFromEnvelope(envelope);\n  if (eventAndAttachments) {\n    const [event, attachments, profile] = eventAndAttachments;\n\n    if (profile) {\n      // We have a 'profile' item and there is no way for us to pass this through event capture\n      // so store them in a cache and reattach them via the `beforeEnvelope` hook before sending\n      rendererProfileFromIpc(event, profile);\n    }\n\n    captureEventFromRenderer(options, event, dynamicSamplingContext, attachments, contents);\n  } else {\n    const normalizedEnvelope = normalizeReplayEnvelope(options, envelope, app.getAppPath());\n    // Pass other types of envelope straight to the transport\n    void getClient()?.getTransport()?.send(normalizedEnvelope);\n  }\n}\n\n/** Is object defined and has keys */\nfunction hasKeys(obj: any): boolean {\n  return obj != undefined && Object.keys(obj).length > 0;\n}\n\n/**\n * Handle scope updates from renderer processes\n */\nfunction handleScope(options: ElectronMainOptionsInternal, jsonScope: string): void {\n  let sentScope: ScopeData;\n  try {\n    sentScope = JSON.parse(jsonScope) as ScopeData;\n  } catch {\n    debug.warn('sentry-electron received an invalid scope message');\n    return;\n  }\n\n  const scope = getCurrentScope();\n\n  if (hasKeys(sentScope.user)) {\n    scope.setUser(sentScope.user);\n  }\n\n  if (hasKeys(sentScope.tags)) {\n    scope.setTags(sentScope.tags);\n  }\n\n  if (hasKeys(sentScope.extra)) {\n    scope.setExtras(sentScope.extra);\n  }\n\n  for (const attachment of sentScope.attachments || []) {\n    scope.addAttachment(attachment);\n  }\n\n  const breadcrumb = sentScope.breadcrumbs.pop();\n  if (breadcrumb) {\n    scope.addBreadcrumb(breadcrumb, options?.maxBreadcrumbs || 100);\n  }\n}\n\nfunction handleLogFromRenderer(\n  client: Client,\n  options: ElectronMainOptionsInternal,\n  log: SerializedLog,\n  contents: WebContents | undefined,\n): void {\n  const process = contents ? options?.getRendererName?.(contents) || 'renderer' : 'renderer';\n\n  log.attributes = log.attributes || {};\n\n  if (options.release) {\n    log.attributes['sentry.release'] = { value: options.release, type: 'string' };\n  }\n\n  if (options.environment) {\n    log.attributes['sentry.environment'] = { value: options.environment, type: 'string' };\n  }\n\n  log.attributes['sentry.sdk.name'] = { value: 'sentry.javascript.electron', type: 'string' };\n  log.attributes['sentry.sdk.version'] = { value: SDK_VERSION, type: 'string' };\n\n  log.attributes['electron.process'] = { value: process, type: 'string' };\n\n  const osDeviceAttributes = getOsDeviceLogAttributes(client);\n\n  if (osDeviceAttributes['os.name']) {\n    log.attributes['os.name'] = { value: osDeviceAttributes['os.name'], type: 'string' };\n  }\n  if (osDeviceAttributes['os.version']) {\n    log.attributes['os.version'] = { value: osDeviceAttributes['os.version'], type: 'string' };\n  }\n  if (osDeviceAttributes['device.brand']) {\n    log.attributes['device.brand'] = { value: osDeviceAttributes['device.brand'], type: 'string' };\n  }\n  if (osDeviceAttributes['device.model']) {\n    log.attributes['device.model'] = { value: osDeviceAttributes['device.model'], type: 'string' };\n  }\n  if (osDeviceAttributes['device.family']) {\n    log.attributes['device.family'] = { value: osDeviceAttributes['device.family'], type: 'string' };\n  }\n\n  _INTERNAL_captureSerializedLog(client, log);\n}\n\n/** Enables Electron protocol handling */\nfunction configureProtocol(client: Client, ipcUtil: IpcUtils, options: ElectronMainOptionsInternal): void {\n  if (app.isReady()) {\n    throw new Error(\"Sentry SDK should be initialized before the Electron app 'ready' event is fired\");\n  }\n\n  const scheme = {\n    scheme: ipcUtil.namespace,\n    privileges: { bypassCSP: true, corsEnabled: true, supportFetchAPI: true, secure: true },\n  };\n\n  protocol.registerSchemesAsPrivileged([scheme]);\n\n  // We Proxy this function so that later user calls to registerSchemesAsPrivileged don't overwrite our custom scheme\n  // eslint-disable-next-line @typescript-eslint/unbound-method\n  protocol.registerSchemesAsPrivileged = new Proxy(protocol.registerSchemesAsPrivileged, {\n    apply: (target, __, args: Parameters<typeof protocol.registerSchemesAsPrivileged>) => {\n      target([...args[0], scheme]);\n    },\n  });\n\n  const rendererStatusChanged = createRendererEventLoopBlockStatusHandler(client);\n\n  app\n    .whenReady()\n    .then(() => {\n      for (const sesh of options.getSessions()) {\n        registerProtocol(sesh.protocol, ipcUtil.namespace, (request) => {\n          const getWebContents = (): WebContents | undefined => {\n            const webContentsId = request.windowId ? WINDOW_ID_TO_WEB_CONTENTS?.get(request.windowId) : undefined;\n            return webContentsId ? webContents.fromId(webContentsId) : undefined;\n          };\n\n          const data = request.body;\n          if (ipcUtil.urlMatches(request.url, 'start')) {\n            newProtocolRenderer();\n          } else if (ipcUtil.urlMatches(request.url, 'scope') && data) {\n            handleScope(options, data.toString());\n          } else if (ipcUtil.urlMatches(request.url, 'envelope') && data) {\n            handleEnvelope(client, options, data, getWebContents());\n          } else if (ipcUtil.urlMatches(request.url, 'structured-log') && data) {\n            handleLogFromRenderer(client, options, JSON.parse(data.toString()), getWebContents());\n          } else if (rendererStatusChanged && ipcUtil.urlMatches(request.url, 'status') && data) {\n            const contents = getWebContents();\n            if (contents) {\n              const status = (JSON.parse(data.toString()) as { status: RendererStatus }).status;\n              rendererStatusChanged(status, contents);\n            }\n          }\n        });\n      }\n    })\n    .catch((error) => debug.error(error));\n}\n\n/**\n * Hooks IPC for communication with the renderer processes\n */\nfunction configureClassic(client: Client, ipcUtil: IpcUtils, options: ElectronMainOptionsInternal): void {\n  ipcMain.on(ipcUtil.createKey('start'), ({ sender }) => {\n    const id = sender.id;\n    // Keep track of renderers that are using IPC\n    KNOWN_RENDERERS = KNOWN_RENDERERS || new Set();\n\n    if (KNOWN_RENDERERS.has(id)) {\n      return;\n    }\n\n    // In older Electron, sender can be destroyed before this callback is called\n    if (!sender.isDestroyed()) {\n      KNOWN_RENDERERS.add(id);\n\n      sender.once('destroyed', () => {\n        KNOWN_RENDERERS?.delete(id);\n      });\n    }\n  });\n  ipcMain.on(ipcUtil.createKey('scope'), (_, jsonScope: string) => handleScope(options, jsonScope));\n  ipcMain.on(ipcUtil.createKey('envelope'), ({ sender }, env: Uint8Array | string) =>\n    handleEnvelope(client, options, env, sender),\n  );\n  ipcMain.on(ipcUtil.createKey('structured-log'), ({ sender }, log: SerializedLog) =>\n    handleLogFromRenderer(client, options, log, sender),\n  );\n\n  const rendererStatusChanged = createRendererEventLoopBlockStatusHandler(client);\n  if (rendererStatusChanged) {\n    ipcMain.on(ipcUtil.createKey('status'), ({ sender }, status: RendererStatus) =>\n      rendererStatusChanged(status, sender),\n    );\n  }\n}\n\n/** Sets up communication channels with the renderer */\nexport function configureIPC(client: Client, options: ElectronMainOptionsInternal): void {\n  const ipcUtil = ipcChannelUtils(options.ipcNamespace);\n\n  // eslint-disable-next-line no-bitwise\n  if ((options.ipcMode & IPCMode.Protocol) > 0) {\n    configureProtocol(client, ipcUtil, options);\n  }\n\n  // eslint-disable-next-line no-bitwise\n  if ((options.ipcMode & IPCMode.Classic) > 0) {\n    configureClassic(client, ipcUtil, options);\n  }\n}\n"],"names":[],"mappings":"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"}