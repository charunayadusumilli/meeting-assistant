{"version":3,"file":"default.js","sources":["../../src/src/common/ipc.ts","../../src/src/preload/index.ts","../../src/src/preload/default.ts"],"sourcesContent":["import { SerializedLog } from '@sentry/core';\n\n/** Ways to communicate between the renderer and main process  */\nexport enum IPCMode {\n  /** Configures Electron IPC to receive messages from renderers */\n  Classic = 1,\n  /** Configures Electron protocol module to receive messages from renderers */\n  Protocol = 2,\n  /**\n   * Configures both methods for best compatibility.\n   *\n   * Renderers favour IPC but fall back to protocol if IPC has not\n   * been configured in a preload script\n   */\n  Both = 3,\n}\n\nexport type Channel =\n  /** IPC to check main process is listening */\n  | 'start'\n  /** IPC to pass scope changes to main process. */\n  | 'scope'\n  /** IPC to pass envelopes to the main process. */\n  | 'envelope'\n  /** IPC to pass renderer status updates */\n  | 'status'\n  /** IPC to pass structured log messages */\n  | 'structured-log';\n\nexport interface IpcUtils {\n  createUrl: (channel: Channel) => string;\n  urlMatches: (url: string, channel: Channel) => boolean;\n  createKey: (channel: Channel) => string;\n  readonly namespace: string;\n}\n\n/**\n * Utility for creating namespaced IPC channels and protocol routes\n */\nexport function ipcChannelUtils(namespace: string): IpcUtils {\n  return {\n    createUrl: (channel: Channel) => {\n      // sentry_key in the url stops these messages from being picked up by our HTTP instrumentations\n      return `${namespace}://${channel}/sentry_key`;\n    },\n    urlMatches: function (url: string, channel: Channel): boolean {\n      return url.startsWith(this.createUrl(channel));\n    },\n    createKey: (channel: Channel) => {\n      return `${namespace}.${channel}`;\n    },\n    namespace,\n  };\n}\n\nexport interface RendererProcessAnrOptions {\n  /**\n   * Interval to send heartbeat messages to the child process.\n   *\n   * Defaults to 1000ms.\n   */\n  pollInterval: number;\n  /**\n   * The number of milliseconds to wait before considering the renderer process to be unresponsive.\n   *\n   * Defaults to 5000ms.\n   */\n  anrThreshold: number;\n  /**\n   * Whether to capture a stack trace when the renderer process is unresponsive.\n   *\n   * Defaults to `false`.\n   */\n  captureStackTrace: boolean;\n}\n\nexport interface RendererStatus {\n  status: 'alive' | 'visible' | 'hidden';\n  config: RendererProcessAnrOptions;\n}\n\nexport interface IPCInterface {\n  sendRendererStart: () => void;\n  sendScope: (scope: string) => void;\n  sendEnvelope: (evn: Uint8Array | string) => void;\n  sendStatus: (state: RendererStatus) => void;\n  sendStructuredLog: (log: SerializedLog) => void;\n}\n\nexport const RENDERER_ID_HEADER = 'sentry-electron-renderer-id';\n\nconst UTILITY_PROCESS_MAGIC_MESSAGE_KEY = '__sentry_message_port_message__';\n\n/** Does the message look like the magic message */\nexport function isMagicMessage(msg: unknown): boolean {\n  return !!(msg && typeof msg === 'object' && UTILITY_PROCESS_MAGIC_MESSAGE_KEY in msg);\n}\n\n/** Get the magic message to send to the utility process */\nexport function getMagicMessage(): unknown {\n  return { [UTILITY_PROCESS_MAGIC_MESSAGE_KEY]: true };\n}\n\n/**\n * We store the IPC interface on window so it's the same for both regular and isolated contexts\n */\ndeclare global {\n  interface Window {\n    __SENTRY_IPC__?: Record<string, IPCInterface>;\n    __SENTRY__RENDERER_INIT__?: boolean;\n    __SENTRY_RENDERER_ID__?: string;\n  }\n}\n","/**\n * This preload script may be used with sandbox mode enabled which means regular require is not available.\n */\n\nimport { SerializedLog } from '@sentry/core';\nimport { contextBridge, ipcRenderer } from 'electron';\nimport { ipcChannelUtils, RendererStatus } from '../common/ipc.js';\n\n/**\n * Hook up IPC to the window object and uses contextBridge if available.\n *\n * @param namespace An optional namespace to use for the IPC channels\n */\nexport function hookupIpc(namespace: string = 'sentry-ipc'): void {\n  const ipcUtil = ipcChannelUtils(namespace);\n\n  // eslint-disable-next-line no-restricted-globals\n  window.__SENTRY_IPC__ = window.__SENTRY_IPC__ || {};\n\n  // eslint-disable-next-line no-restricted-globals\n  if (window.__SENTRY_IPC__[ipcUtil.namespace]) {\n    // eslint-disable-next-line no-console\n    console.log('Sentry Electron preload has already been run');\n  } else {\n    const ipcObject = {\n      sendRendererStart: () => ipcRenderer.send(ipcUtil.createKey('start')),\n      sendScope: (scopeJson: string) => ipcRenderer.send(ipcUtil.createKey('scope'), scopeJson),\n      sendEnvelope: (envelope: Uint8Array | string) => ipcRenderer.send(ipcUtil.createKey('envelope'), envelope),\n      sendStatus: (status: RendererStatus) => ipcRenderer.send(ipcUtil.createKey('status'), status),\n      sendStructuredLog: (log: SerializedLog) => ipcRenderer.send(ipcUtil.createKey('structured-log'), log),\n    };\n\n    // eslint-disable-next-line no-restricted-globals\n    window.__SENTRY_IPC__[ipcUtil.namespace] = ipcObject;\n\n    // We attempt to use contextBridge if it's available\n    if (contextBridge) {\n      // This will fail if contextIsolation is not enabled\n      try {\n        // eslint-disable-next-line no-restricted-globals\n        contextBridge.exposeInMainWorld('__SENTRY_IPC__', window.__SENTRY_IPC__);\n      } catch (e) {\n        //\n      }\n    }\n  }\n}\n","import { hookupIpc } from './index.js';\n\nhookupIpc();\n"],"names":[],"mappings":";;AAEA;AACA,IAAY,OAYX;AAZD,CAAA,UAAY,OAAO,EAAA;;AAEjB,IAAA,OAAA,CAAA,OAAA,CAAA,SAAA,CAAA,GAAA,CAAA,CAAA,GAAA,SAAW;;AAEX,IAAA,OAAA,CAAA,OAAA,CAAA,UAAA,CAAA,GAAA,CAAA,CAAA,GAAA,UAAY;AACZ;;;;;AAKG;AACH,IAAA,OAAA,CAAA,OAAA,CAAA,MAAA,CAAA,GAAA,CAAA,CAAA,GAAA,MAAQ;AACV,CAAC,EAZW,OAAO,KAAP,OAAO,GAAA,EAAA,CAAA,CAAA;AAiCnB;;AAEG;AACG,SAAU,eAAe,CAAC,SAAiB,EAAA;IAC/C,OAAO;AACL,QAAA,SAAS,EAAE,CAAC,OAAgB,KAAI;;AAE9B,YAAA,OAAO,CAAA,EAAG,SAAS,CAAA,GAAA,EAAM,OAAO,aAAa;QAC/C,CAAC;AACD,QAAA,UAAU,EAAE,UAAU,GAAW,EAAE,OAAgB,EAAA;YACjD,OAAO,GAAG,CAAC,UAAU,CAAC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;QAChD,CAAC;AACD,QAAA,SAAS,EAAE,CAAC,OAAgB,KAAI;AAC9B,YAAA,OAAO,CAAA,EAAG,SAAS,CAAA,CAAA,EAAI,OAAO,EAAE;QAClC,CAAC;QACD,SAAS;KACV;AACH;;ACrDA;;AAEG;AAMH;;;;AAIG;AACG,SAAU,SAAS,CAAC,SAAA,GAAoB,YAAY,EAAA;AACxD,IAAA,MAAM,OAAO,GAAG,eAAe,CAAC,SAAS,CAAC;;IAG1C,MAAM,CAAC,cAAc,GAAG,MAAM,CAAC,cAAc,IAAI,EAAE;;IAGnD,IAAI,MAAM,CAAC,cAAc,CAAC,OAAO,CAAC,SAAS,CAAC,EAAE;;AAE5C,QAAA,OAAO,CAAC,GAAG,CAAC,8CAA8C,CAAC;AAC5D,IAAA;AAAM,SAAA;AACL,QAAA,MAAM,SAAS,GAAG;AAChB,YAAA,iBAAiB,EAAE,MAAM,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC;AACrE,YAAA,SAAS,EAAE,CAAC,SAAiB,KAAK,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,OAAO,CAAC,EAAE,SAAS,CAAC;AACzF,YAAA,YAAY,EAAE,CAAC,QAA6B,KAAK,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,UAAU,CAAC,EAAE,QAAQ,CAAC;AAC1G,YAAA,UAAU,EAAE,CAAC,MAAsB,KAAK,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,QAAQ,CAAC,EAAE,MAAM,CAAC;AAC7F,YAAA,iBAAiB,EAAE,CAAC,GAAkB,KAAK,WAAW,CAAC,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,gBAAgB,CAAC,EAAE,GAAG,CAAC;SACtG;;QAGD,MAAM,CAAC,cAAc,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,SAAS;;AAGpD,QAAA,IAAI,aAAa,EAAE;;YAEjB,IAAI;;gBAEF,aAAa,CAAC,iBAAiB,CAAC,gBAAgB,EAAE,MAAM,CAAC,cAAc,CAAC;AACzE,YAAA;AAAC,YAAA,OAAO,CAAC,EAAE;;AAEX,YAAA;AACF,QAAA;AACF,IAAA;AACH;;AC5CA,SAAS,EAAE"}