{"version":3,"file":"child-process.js","sources":["../../src/src/main/integrations/child-process.ts"],"sourcesContent":["import {\n  addBreadcrumb,\n  captureMessage,\n  defineIntegration,\n  Log,\n  ParameterizedString,\n  SeverityLevel,\n} from '@sentry/core';\nimport { childProcessIntegration as nodeChildProcessIntegration, logger, NodeClient } from '@sentry/node';\nimport { app } from 'electron';\nimport { EXIT_REASONS, ExitReason } from '../electron-normalize.js';\nimport { ElectronMainOptions } from '../sdk.js';\n\ntype NodeChildProcessOptions = NonNullable<Parameters<typeof nodeChildProcessIntegration>[0]>;\n\ntype OrBool<T> = {\n  [P in keyof T]: T[P] | boolean;\n};\n\nexport interface ChildProcessOptions extends NodeChildProcessOptions {\n  /** Child process events that generate breadcrumbs */\n  breadcrumbs: Readonly<ExitReason[]>;\n  /** Child process events that generate Sentry events */\n  events: Readonly<ExitReason[]>;\n}\n\nconst DEFAULT_OPTIONS: ChildProcessOptions = {\n  breadcrumbs: EXIT_REASONS,\n  events: ['abnormal-exit', 'launch-failed', 'integrity-failure'],\n};\n\ntype LogFn = (msg: ParameterizedString, attributes: Log['attributes']) => void;\n\n/** Gets message and severity */\nfunction getMessageAndSeverity(\n  reason: ExitReason,\n  process: string,\n): { message: string; messageFmt: ParameterizedString; level: SeverityLevel; log: LogFn } {\n  const message = `'${process}' process exited with '${reason}'`;\n  const messageFmt = logger.fmt`'${process}' process exited with '${reason}'`;\n\n  switch (reason) {\n    case 'abnormal-exit':\n    case 'killed':\n      return { message, level: 'warning', log: logger.warn, messageFmt };\n    case 'crashed':\n    case 'oom':\n    case 'launch-failed':\n    case 'integrity-failure':\n      return { message, level: 'fatal', log: logger.error, messageFmt };\n    default:\n      return { message, level: 'debug', log: logger.info, messageFmt };\n  }\n}\n\n/**\n * Adds breadcrumbs for:\n * - Electron child process events\n * - Node `child_process` events\n * - Node `worker_threads` events\n */\nexport const childProcessIntegration = defineIntegration((userOptions: Partial<OrBool<ChildProcessOptions>> = {}) => {\n  const { breadcrumbs, events } = userOptions;\n\n  const nodeIntegration = nodeChildProcessIntegration(userOptions);\n\n  const options: ChildProcessOptions = {\n    breadcrumbs: Array.isArray(breadcrumbs) ? breadcrumbs : breadcrumbs === false ? [] : DEFAULT_OPTIONS.breadcrumbs,\n    events: Array.isArray(events) ? events : events === false ? [] : DEFAULT_OPTIONS.events,\n  };\n\n  return {\n    name: 'ChildProcess',\n    setup(client: NodeClient) {\n      nodeIntegration.setup?.(client);\n\n      const { breadcrumbs, events } = options;\n      const allReasons = Array.from(new Set([...breadcrumbs, ...events]));\n\n      // only hook these events if we're after more than just the unresponsive event\n      if (allReasons.length > 0) {\n        const clientOptions = client.getOptions() as ElectronMainOptions;\n        const enableLogs = !!clientOptions?.enableLogs;\n\n        app.on('child-process-gone', (_, details) => {\n          const { reason } = details;\n          const { message, level, log, messageFmt } = getMessageAndSeverity(details.reason, details.type);\n\n          // Capture message first\n          if (events.includes(reason)) {\n            captureMessage(message, { level, tags: { 'event.process': details.type } });\n          }\n\n          // And then add breadcrumbs for subsequent events\n          if (breadcrumbs.includes(reason)) {\n            addBreadcrumb({\n              type: 'process',\n              category: 'child-process',\n              message,\n              level,\n              data: details,\n            });\n\n            if (enableLogs) {\n              log(messageFmt, {\n                'sentry.origin': 'auto.electron.child-process',\n                exitCode: details.exitCode,\n                name: details.name,\n                serviceName: details.serviceName,\n              });\n            }\n          }\n        });\n\n        app.on('render-process-gone', (_, contents, details) => {\n          const { reason } = details;\n          const name = clientOptions?.getRendererName?.(contents) || 'renderer';\n          const { message, level, log, messageFmt } = getMessageAndSeverity(details.reason, name);\n\n          // Capture message first\n          if (events.includes(reason)) {\n            captureMessage(message, level);\n          }\n\n          // And then add breadcrumbs for subsequent events\n          if (breadcrumbs.includes(reason)) {\n            addBreadcrumb({\n              type: 'process',\n              category: 'child-process',\n              message,\n              level,\n              data: details,\n            });\n\n            if (enableLogs) {\n              log(messageFmt, {\n                'sentry.origin': 'auto.electron.child-process',\n                exitCode: details.exitCode,\n              });\n            }\n          }\n        });\n      }\n    },\n  };\n});\n"],"names":["EXIT_REASONS","logger","defineIntegration","nodeChildProcessIntegration","app","captureMessage","addBreadcrumb"],"mappings":"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"}