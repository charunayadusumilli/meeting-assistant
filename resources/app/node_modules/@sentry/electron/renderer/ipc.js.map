{"version":3,"file":"ipc.js","sources":["../src/src/renderer/ipc.ts"],"sourcesContent":["/* eslint-disable no-restricted-globals */\n/* eslint-disable no-console */\nimport { Client, debug, getClient, SerializedLog, uuid4 } from '@sentry/core';\nimport { ipcChannelUtils, IPCInterface, RENDERER_ID_HEADER, RendererStatus } from '../common/ipc.js';\nimport { ElectronRendererOptionsInternal } from './sdk.js';\n\n/** Gets the available IPC implementation */\nfunction getImplementation(ipcKey: string): IPCInterface {\n  const ipcUtil = ipcChannelUtils(ipcKey);\n\n  // Favour IPC if it's been exposed by a preload script\n  if (window.__SENTRY_IPC__?.[ipcUtil.namespace]) {\n    return window.__SENTRY_IPC__[ipcUtil.namespace] as IPCInterface;\n  } else {\n    debug.log('IPC was not configured in preload script, falling back to custom protocol and fetch');\n\n    // A unique ID used to identify this renderer and is send in the headers of every request\n    // Because it added as a global, this can be fetched from the main process via executeJavaScript\n    const id = (window.__SENTRY_RENDERER_ID__ = uuid4());\n    const headers: Record<string, string> = { [RENDERER_ID_HEADER]: id };\n\n    return {\n      sendRendererStart: () => {\n        fetch(ipcUtil.createUrl('start'), { method: 'POST', body: '', headers }).catch(() => {\n          console.error(`Sentry SDK failed to establish connection with the Electron main process.\n  - Ensure you have initialized the SDK in the main process\n  - If your renderers use custom sessions, be sure to set 'getSessions' in the main process options\n  - If you are bundling your main process code and using Electron < v5, you'll need to manually configure a preload script`);\n        });\n      },\n      sendScope: (body: string) => {\n        fetch(ipcUtil.createUrl('scope'), { method: 'POST', body, headers }).catch(() => {\n          // ignore\n        });\n      },\n      sendEnvelope: (body: string | Uint8Array) => {\n        fetch(ipcUtil.createUrl('envelope'), { method: 'POST', body, headers }).catch(() => {\n          // ignore\n        });\n      },\n      sendStatus: (status: RendererStatus) => {\n        fetch(ipcUtil.createUrl('status'), {\n          method: 'POST',\n          body: JSON.stringify({ status }),\n          headers,\n        }).catch(() => {\n          // ignore\n        });\n      },\n      sendStructuredLog: (log: SerializedLog) => {\n        fetch(ipcUtil.createUrl('structured-log'), {\n          method: 'POST',\n          body: JSON.stringify(log),\n          headers,\n        }).catch(() => {\n          // ignore\n        });\n      },\n    };\n  }\n}\n\nlet cachedInterfaces: WeakMap<Client, IPCInterface> | undefined;\n\n/**\n * Renderer IPC interface\n *\n * Favours IPC if its been exposed via a preload script but will\n * fallback to custom protocol and fetch if IPC is not available\n */\nexport function getIPC(client: Client | undefined = getClient()): IPCInterface {\n  if (!client) {\n    throw new Error('Could not find client, make sure to call Sentry.init before getIPC');\n  }\n\n  if (!cachedInterfaces) {\n    cachedInterfaces = new WeakMap();\n  }\n\n  const found = cachedInterfaces.get(client);\n\n  if (found) {\n    return found;\n  }\n\n  const namespace = (client.getOptions() as ElectronRendererOptionsInternal).ipcNamespace;\n  const implementation = getImplementation(namespace);\n  cachedInterfaces.set(client, implementation);\n  implementation.sendRendererStart();\n\n  return implementation;\n}\n"],"names":["ipcChannelUtils","debug","uuid4","RENDERER_ID_HEADER","getClient"],"mappings":"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"}